{% extends "base.html" %}
{% load humanize %}

{% block title %}{% if request.GET.q and request.GET.q == " " %}All Data{% else %}Search Results: {% if request.GET.sequence %}BLAST{% elif request.GET.q and request.GET.q != " " %}{{ request.GET.q }}{% else %}Advanced {% endif %}{% endif %}{% endblock %}

{% block main %}
{% if results.count %}
    <div class="box search-head">
        <h2>{{ results.count|intcomma }} result{% if results.count != 1 %}s{% endif %} {% if results.num_pages > 1 %} <span>(Page {{ page.number }} of {{ results.num_pages }})</span>{% endif %}</h2>

        {% if not chains %}
        <select onchange="resortResults(this);">
            <option value="-deposited"{% if request.GET.sort == '-deposited' or 'sort' not in request.GET %} selected{% endif %}>Newest to Oldest</option>
            <option value="deposited"{% if request.GET.sort == 'deposited' %} selected {% endif %}>Oldest to Newest</option>
            <option value="resolution"{% if request.GET.sort == 'resolution' %} selected {% endif %}>Resolution (Best to Worst)</option>
            <option value="-resolution"{% if request.GET.sort == '-resolution' %} selected {% endif %}>Resolution (Worst to Best)</option>
            <option value="rfactor"{% if request.GET.sort == 'rfactor' %} selected {% endif %}>R-value (Best to Worst)</option>
            <option value="-rfactor"{% if request.GET.sort == '-rfactor' %} selected {% endif %}>R-value (Worst to Best)</option>
            <option value="title"{% if request.GET.sort == 'title' %} selected {% endif %}>PDB Title (A-Z)</option>
            <option value="-title"{% if request.GET.sort == '-title' %} selected {% endif %}>PDB Title (Z-A)</option>
            <option value="id"{% if request.GET.sort == 'id' %} selected {% endif %}>PDB Code (A-Z)</option>
            <option value="-id"{% if request.GET.sort == '-id' %} selected {% endif %}>PDB Code (Z-A)</option>
        </select>
        {% endif %}
    </div>

    {% include "search-nav.html" %}

    {% for object in page %}
    <div class="search-result">
        {% if chains %}
        <div class="pdb-result">
            <div class="pdb-result-main">
                <div class="pdb-code">Chain {{ object.chain_pdb_identifier }} (<a href="/pdbs/{{ object.pdb.id }}/">{{ object.pdb.id }}</a>)</div>
                <div class="pdb-deposited">Score: {{ object.blast_data.score }}</div>
                <div class="pdb-species">E-value: {{ object.blast_data.evalue }}</div>
                <div class="pdb-deposited">{{ object.pdb.title }}</div>
            </div>
            <div class="sequence-alignment">
                <pre class="alignment-row">Query: {{ object.blast_data.qseq }}</pre>
                <pre class="alignment-row">       {{ object.blast_data.midline }}</pre>
                <pre class="alignment-row">Match: {{ object.blast_data.hseq }}</pre>
            </div>
        </div>
        {% else %}
        <a class="pdb-result" href="/pdbs/{{ object.0.pdb_id }}/">
            <div class="pdb-result-main">
                <div class="pdb-code">PDB: {{ object.0.pdb_id }}</div>
                <div class="pdb-deposited">{{ object.0.deposited }}</div>
                <div class="pdb-species"><script>document.write(formatSpecies("{{ object.0.species }}"));</script></div>
            </div>
            <div class="pdb-title">{{ object.0.title|truncatewords:20 }}</div>
            <div class="pdb-secondary">
                 {{ object.0.classification}} |
                 {{ object.0.technique }}{% if object.0.resolution %} ({{ object.0.resolution }} Ã…){% endif %}
             </div>
        </a>
        {% endif %}

        <div class="site-results">
            {% if chains %}
            {% for site in object.zincsites %}
            {% include "zinc-site-summary.html" %}
            {% endfor %}
            {% else %}
            {% for site in object %}
            {% include "zinc-site-summary.html" %}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    {% endfor %}

    {% include "search-nav.html" %}
{% else %}
    <div class="box no-results">
        <h2>There were no results matching your query.</h2>
        <p>
            {% if chains %}
            BLAST search currently requires peptide sequences only - did you
            submit a nucleotide sequence?
            {% elif request.GET.q %}
            Search is case-insensitive, and searches PDB codes (for exact matches)
            and PDB descriptions, classifications, organisms, and experimental
            techniques (for partial matches).
            {% else %}
            Perhaps try a more vague search?
            {% endif %}
        </p>
    </div>
{% endif %}
{% endblock %}
